## First let's try out some terraform state commands
## Go to the m3 folder and run the state commands

# View all the Terraform resources
terraform state list

# Now let's look at a specific resource
terraform state show module.vpc.aws_vpc.this[0]

# We can also view all the state data
terraform state pull

## Now it's time to deploy our local Consul server node
## Download the consul executable from https://www.consul.io/downloads

# Go into the consul subfolder in m4
cd ../m4/consul

# Create a data subdirectory
mkdir data

# Launch consul server instance
consul agent -bootstrap -config-file="config/consul-config.hcl" -bind="127.0.0.1"

# Open a separate terminal window to run the rest of the commands
# Make sure you are back in the m4/consul directory
cd m4/consul

# Generate the bootstrap token
consul acl bootstrap

/* root token
                        AccessorID:       5c86b991-fa2e-e602-1c94-d90171de043a
                        SecretID:         f3a81a62-b373-3b49-3b3c-6853656f6868
                        Description:      Bootstrap Token (Global Management)
                        Local:            false
                        Create Time:      2022-03-03 15:46:28.934503061 +0100 CET
                        Policies:
                        00000000-0000-0000-0000-000000000001 - global-management
*/

# Set CONSUL_TOKEN to SecretID

# Linux and MacOS
export CONSUL_HTTP_TOKEN=f3a81a62-b373-3b49-3b3c-6853656f6868

# Windows
$env:CONSUL_HTTP_TOKEN="SECRETID_VALUE"

## Now we're going to configure Consul using Terraform 
# Set up paths, policies, and tokens
terraform init
terraform plan -out consul.tfplan
terraform apply consul.tfplan

                        mary_token_accessor_id = "f8174a2e-13f7-c6cb-90cf-e6552cd990a3"
                            AccessorID:       f8174a2e-13f7-c6cb-90cf-e6552cd990a3
                            SecretID:         aefe1ff6-6def-1fda-623a-42d973da21b3
                            Description:      token for Mary Moe
                            Local:            false
                            Create Time:      2022-03-03 17:01:49.36050322 +0100 CET
                            Policies:
                            d91ee137-dc1f-afd3-067b-715962249af8 - networking
                        
                        sally_token_accessor_id = "85efc89f-9be6-9f52-ae68-e1e8bdf93f29"
                            AccessorID:       85efc89f-9be6-9f52-ae68-e1e8bdf93f29
                            SecretID:         f6f8a1c7-8d54-98c6-b928-b46d3ce782e1
                            Description:      token for Sally Sue
                            Local:            false
                            Create Time:      2022-03-03 17:01:49.361670503 +0100 CET
                            Policies:
                            a15e6b61-86f2-7362-c17f-fb134b698044 - applications

# Get token values for Mary and Sally and record them for later
consul acl token read -id ACCESSOR_ID_MARY
consul acl token read -id ACCESSOR_ID_SALLY

# Go back to the main m4 folder
cd ..

## Now let's set up the Consul backend and migrate the state

# Copy the backend.tf file to m3
cp backend.tf ..\m3\backend.tf

# Move to the m3 folder
cd ..\m3

# Now let's set the Consul token to Mary Moe
# Replace SECRETID_VALUE with Mary Moe's secret ID
# Linux and MacOS
export CONSUL_HTTP_TOKEN=SECRETID_VALUE

# Windows
$env:CONSUL_HTTP_TOKEN="SECRETID_VALUE"

# Now we can initialize the backend config
terraform init -backend-config="path=networking/state/globo-primary"

# Change the enable_nat_gateway to true in the resources.tf file

# Now run terraform plan and apply
terraform plan -out nat.tfplan
terraform apply nat.tfplan

# Open a second terminal
# Export the Consul token again
# Try to run a terraform plan
terraform plan

## You can stop your Consul instance if you want now, or leave it running
## for the next module

## We are going to keep using the infrastructure in AWS for m5, so don't destroy it!